# 🚀 일기 생성 고도화 기능 빠른 시작 가이드

## 📋 요약

이 업데이트로 다음 기능이 추가되었습니다:

1. **진짜 일기처럼 자연스러운 일기 생성** 
   - 어르신의 실제 말투와 스타일 학습
   - 시간 순서대로 구체적인 디테일 포함
   - 감정 표현이 풍부한 일기

2. **통화 중 할 일 자동 감지 → TODO 추천**
   - "내일 병원 가야 해" 같은 표현 자동 감지
   - 날짜, 시간, 우선순위 자동 설정
   - 일기 확인 시 "TODO에 추가하시겠습니까?" UI 제공

---

## 🔧 설치 및 설정

### 1. 백엔드 환경 확인

```bash
cd backend

# OpenAI API Key 확인 (.env 파일)
OPENAI_API_KEY=sk-...

# 필요한 패키지 설치 (이미 설치되어 있을 것)
pip install openai
```

### 2. 서버 실행

```bash
# 1. FastAPI 서버 실행
uvicorn app.main:app --reload

# 2. Celery Worker 실행 (다른 터미널)
celery -A app.tasks.celery_app worker --loglevel=info
```

---

## 📱 사용 플로우

### 1단계: AI 전화 통화

```
1. 앱에서 "AI 전화" 버튼 클릭
2. 어르신과 AI가 대화
3. 대화 중 할 일 언급:
   "내일 병원 가야 해"
   "모레 약 타러 가야지"
   "다음주 월요일에 친구 만나기로 했어"
```

### 2단계: 자동 일기 생성 (백그라운드)

```
통화 종료
  ↓
Celery Task 자동 실행
  ↓
1. 통화 내용 구조화 분석
2. 어르신 스타일 반영한 일기 생성
3. TODO 자동 감지
  ↓
일기 생성 완료 (Draft 상태)
```

### 3단계: 일기 확인 및 TODO 추천

```tsx
// 사용자가 일기 화면 진입
일기 목록
  ↓
일기 상세 화면
  ↓
[AI 생성 일기라면]
  ↓
📌 감지된 일정 섹션 표시
  ↓
□ 병원 가기 (2025-10-21, 중요)
□ 약국에서 약 타오기 (2025-10-22)
□ 친구 만남 (2025-10-27)
  ↓
사용자가 체크박스 선택
  ↓
"선택한 3개 할 일 추가" 버튼 클릭
  ↓
TODO 테이블에 실제 등록
  ↓
✅ 완료! (TODO 화면에서 확인 가능)
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 병원 예약

**통화 내용:**
```
AI: "오늘 어떻게 지내셨어요?"
어르신: "잘 지냈어. 내일 병원 가야 하는데 걱정이야."
AI: "병원 예약이 있으시군요. 몇 시에 가시나요?"
어르신: "오후 2시야."
```

**예상 결과:**
```json
{
  "suggested_todos": [
    {
      "title": "병원 가기",
      "due_date": "2025-10-21",
      "due_time": "14:00",
      "priority": "high",
      "category": "건강"
    }
  ]
}
```

**생성된 일기:**
```
오늘은 평온한 하루였다.
내일 오후 2시에 병원 가야 하는데 조금 걱정이 된다.
하지만 정기검진이니까 다녀와야지.
```

---

### 시나리오 2: 약 복용 및 장보기

**통화 내용:**
```
AI: "오늘 약은 드셨나요?"
어르신: "아침약은 먹었어. 근데 약이 얼마 안 남았네. 모레 약국 가야겠어."
AI: "그러시군요. 다른 필요한 것도 있으신가요?"
어르신: "마트도 가야 해. 우유랑 과일 좀 사야지."
```

**예상 결과:**
```json
{
  "suggested_todos": [
    {
      "title": "약국에서 약 타오기",
      "due_date": "2025-10-22",
      "priority": "high",
      "category": "건강"
    },
    {
      "title": "마트 장보기",
      "description": "우유, 과일",
      "due_date": "2025-10-22",
      "priority": "medium",
      "category": "외출"
    }
  ]
}
```

**생성된 일기:**
```
오늘도 아침약은 잘 챙겨 먹었다.
약이 얼마 안 남아서 모레 약국에 가야겠다.
김에 마트도 들러서 우유랑 과일도 좀 사와야지.
요즘 과일값이 비싸긴 하지만, 건강을 위해서는 먹어야 하니까.
```

---

## 🎨 프론트엔드 UI 예시

### 일기 상세 화면 (TODO 추천 포함)

```
┌─────────────────────────────────────┐
│  📝 오늘의 일기                      │
│  2025년 10월 20일 일요일             │
├─────────────────────────────────────┤
│                                     │
│  오늘은 날씨가 좋아서 아침 일찍      │
│  공원에 다녀왔다. 요즘 걷기 운동을   │
│  하니까 다리가 좀 나아진 것 같다.    │
│                                     │
│  집에 오니 딸애가 와 있더라.         │
│  미역국을 끓여놨길래 맛있게 먹었다.  │
│  역시 딸이 해준 밥이 제일 맛있어.    │
│                                     │
│  딸이 내일 병원에 같이 가자고 했다.  │
│  무릎 검진 받아야 하는데 혼자 가기   │
│  귀찮았는데 다행이다.               │
│                                     │
├─────────────────────────────────────┤
│  📌 감지된 일정                      │
│  통화 중 언급된 할 일이 2개          │
│  발견되었습니다.                     │
├─────────────────────────────────────┤
│  ☑ 병원 가기 [중요]                 │
│     📅 2025-10-21 (내일)            │
│     🏥 무릎 검진                     │
│                                     │
│  ☐ 약국에서 약 타오기                │
│     📅 2025-10-23                   │
│     💊 고혈압 약                     │
├─────────────────────────────────────┤
│  [선택한 1개 할 일 추가]   👈 버튼   │
└─────────────────────────────────────┘
```

---

## 📊 로그 확인

### Celery Worker 로그에서 확인할 수 있는 정보

```bash
# 1. 일기 생성 시작
============================================================
📝 고도화된 일기 생성 시작: CA123456...
============================================================

# 2. 통화 기록 조회
✅ 통화 기록 조회 완료 (발화 수: 15)

# 3. 통화 내용 분석
📊 통화 내용 분석 시작 (총 15개 발화)
✅ 통화 분석 완료:
   - 활동: 3개
   - 감정: 2개
   - 향후 일정: 2개
   - 할 일(TODO): 2개

# 4. 일기 생성
📝 개인화된 일기 생성 시작 (사용자: 김영희)
📊 일기 스타일 분석 완료
✅ 일기 생성 완료 (327자)

# 5. TODO 감지
📋 TODO 감지: 2개
📌 TODO 감지: 병원 가기 (기한: 2025-10-21)
📌 TODO 감지: 약국에서 약 타오기 (기한: 2025-10-23)

# 6. 완료
============================================================
✅ 일기 생성 완료!
   - 일기 ID: d789...
   - 일기 길이: 327자
   - TODO 추천: 2개
============================================================
```

---

## 🐛 트러블슈팅

### 문제 1: TODO가 감지되지 않음

**원인:**
- 통화 내용에 명확한 날짜 언급이 없음
- "~해야 해", "~가야 해" 같은 표현이 없음

**해결:**
- 통화 중 더 구체적으로 질문
  - ❌ "무슨 일 있으세요?"
  - ✅ "다음주에 계획이 있으신가요?"

### 문제 2: 일기가 너무 짧거나 어색함

**원인:**
- 통화 내용이 너무 짧음 (1-2분 미만)
- 최근 일기가 없어서 스타일 학습 불가

**해결:**
- 최소 5분 이상 통화 권장
- 다양한 주제 대화 (식사, 건강, 가족, 취미 등)

### 문제 3: 날짜 파싱 오류

**현재 지원되는 날짜 표현:**
- ✅ "내일", "모레", "글피"
- ✅ "다음주", "다음주 월요일"
- ✅ "YYYY-MM-DD" 형식
- ❌ "이따가", "나중에" (파싱 불가)

---

## 📈 성능 지표

### 일기 생성 시간

```
1. 통화 내용 분석: 2-3초
2. 일기 생성: 3-5초
3. TODO 추출: 1-2초
──────────────────────
총 소요 시간: 6-10초
```

### LLM 토큰 사용량

```
- 통화 분석 (JSON 모드): ~1,500 tokens
- 일기 생성: ~2,000 tokens
- 스타일 분석 (선택): ~500 tokens
──────────────────────────────
총: ~4,000 tokens/일기
```

### 비용 추정 (GPT-4o-mini 기준)

```
Input: $0.15 / 1M tokens
Output: $0.60 / 1M tokens

일기 1개당: 약 $0.003 (약 4원)
월 100개: 약 $0.30 (약 400원)
```

---

## 🎯 다음 단계

### Phase 1: 기능 테스트 (현재)
- [x] 백엔드 구현 완료
- [ ] 프론트엔드 통합
- [ ] 실제 사용자 테스트

### Phase 2: 최적화
- [ ] 프롬프트 개선 (사용자 피드백 기반)
- [ ] 날짜 파싱 정확도 향상
- [ ] 일기 품질 검증 시스템

### Phase 3: 확장
- [ ] 사진 첨부 시 이미지 분석
- [ ] 음성 톤 분석 (감정 강화)
- [ ] 장기 패턴 분석 대시보드

---

## 📞 문의

문제가 발생하거나 기능 개선 제안이 있으시면 이슈를 등록해주세요!

